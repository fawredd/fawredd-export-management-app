datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// ORGANIZATION & SAAS
// ============================================

model Organization {
  id          String   @id @default(cuid())
  name        String
  plan        Plan     @default(FREE)
  users       User[]
  providers   Provider[]
  clients     Client[]
  products    Product[]
  budgets     Budget[]
  costs       Cost[]
  invoices    Invoice[]
  packingLists PackingList[]
  exportTasks ExportTask[]
  taxes       Tax[]
  pricingConfiguration  PricingConfiguration?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum Plan {
  FREE
  PRO
  PREMIUM
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id             String        @id @default(cuid())
  email          String        @unique
  password       String
  name           String?
  role           Role          @default(CLIENT)
  organization   Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  auditLogs      AuditLog[]
}

enum Role {
  ADMIN
  TRADER
  MANUFACTURER
  CLIENT
}

// ============================================
// PROVIDERS & CLIENTS
// ============================================

model Provider {
  id             String        @id @default(cuid())
  name           String
  email          String?
  phone          String?
  address        String?
  taxId          String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?
  products       Product[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model Client {
  id             String        @id @default(cuid())
  name           String
  email          String?
  phone          String?
  address        String?
  taxId          String?
  status         ClientStatus  @default(PROSPECT)
  convertedFrom  String?       // Track if converted from prospect (budget shareToken)
  organization   Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?
  budgets        Budget[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

enum ClientStatus {
  PROSPECT
  CLIENT
}

// ============================================
// PRODUCTS & CATALOG
// ============================================

model Product {
  id               String          @id @default(cuid())
  sku              String          @unique
  title            String
  description      String?
  imageUrls        String[]        // Product photos
  isPublic         Boolean         @default(false) // Visibility in public catalog
  weightKg         Float?
  volumeM3         Float?
  composition      String?
  tariffPosition   TariffPosition? @relation(fields: [tariffPositionId], references: [id])
  tariffPositionId String?
  unit             UnitOfMeasure?  @relation(fields: [unitId], references: [id])
  unitId           String?
  provider         Provider?       @relation(fields: [providerId], references: [id])
  providerId       String?
  organization     Organization?   @relation(fields: [organizationId], references: [id])
  organizationId   String?
  priceHistory     PriceHistory[]
  taxes            Tax[]
  exportTasks      ExportTask[]
  budgetItems      BudgetItem[]
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
}

model TariffPosition {
  id                   String    @id @default(cuid())
  code                 String    @unique
  description          String
  dutyRate             Decimal?  @db.Decimal(8, 4)  // Import duty rate
  adValoremRate        Decimal?  @db.Decimal(8, 4)  // Export duty percentage (DEX)
  fixedExportDuty      Decimal?  @db.Decimal(20, 6) // Fixed export duty amount
  exportDutyMinAmount  Decimal?  @db.Decimal(20, 6) // Minimum export duty
  exportDutyMaxAmount  Decimal?  @db.Decimal(20, 6) // Maximum export duty
  products             Product[]
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
}

model UnitOfMeasure {
  id           String    @id @default(cuid())
  name         String
  abbreviation String    @unique
  products     Product[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model PriceHistory {
  id        String    @id @default(cuid())
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String
  type      PriceType
  value     Decimal   @db.Decimal(20, 6)
  date      DateTime  @default(now())
  createdAt DateTime  @default(now())
}

enum PriceType {
  COST
  SELLING
}

model Tax {
  id             String        @id @default(cuid())
  product        Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId      String
  name           String
  percentage     Decimal       @db.Decimal(8, 4)
  organization   Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

// ============================================
// EXPORT TASKS & COUNTRIES
// ============================================

model ExportTask {
  id          String     @id @default(cuid())
  description String
  status      TaskStatus @default(PENDING)
  country     Country    @relation(fields: [countryId], references: [id])
  countryId   String
  products    Product[]
  dueDate     DateTime?
  completedAt DateTime?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model Country {
  id          String       @id @default(cuid())
  name        String
  code        String       @unique
  exportTasks ExportTask[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

// ============================================
// COSTS
// ============================================

model Cost {
  id                     String    @id @default(cuid())
  type                   CostType
  description            String?
  value                  Decimal   @db.Decimal(20, 6)
  prorate                Boolean   @default(false)  // Should this cost be prorated across products?
  perUnitOrTotal         CostScope @default(TOTAL)  // Is value per unit or total?
  incotermToBeIncluded   Incoterm  @relation("CostIncotermLimit", fields: [incotermToBeIncludedId], references: [id])
  incotermToBeIncludedId String    // Include this cost for all Incoterms up to and including this one
  budgets                Budget[]
  organization           Organization? @relation(fields: [organizationId], references: [id])
  organizationId         String?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
}

enum CostScope {
  PER_UNIT
  TOTAL
}

enum CostType {
  FIXED
  VARIABLE
  FREIGHT
  INSURANCE
}

// ============================================
// BUDGETS & BUDGET ITEMS
// ============================================

model Budget {
  id             String        @id @default(cuid())
  client         Client        @relation(fields: [clientId], references: [id])
  clientId       String
  organization   Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?
  incoterm       Incoterm @relation(fields: [incotermId], references: [id])
  incotermId     String 
  status         BudgetStatus  @default(DRAFT)
  totalAmount    Decimal?      @db.Decimal(20, 6)
  shareToken     String?       @unique // For public sharing
  expiresAt      DateTime?     // Optional expiration for shared link
  viewCount      Int           @default(0) // Track views
  acceptedAt     DateTime?     // When budget was accepted
  acceptedBy     String?       // Prospect email/name who accepted
  budgetItems    BudgetItem[]
  costs          Cost[]
  invoices       Invoice[]
  packingLists   PackingList[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model Incoterm {
  id                   String     @id @default(cuid())
  name                 String     @unique
  previousIncoterm     Incoterm?  @relation("IncotermHierarchy", fields: [previousIncotermId], references: [id])
  previousIncotermId   String?
  nextIncoterms        Incoterm[] @relation("IncotermHierarchy")
  budgets              Budget[]
  costsIncludedUpTo    Cost[]     @relation("CostIncotermLimit")
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
}

enum BudgetStatus {
  DRAFT
  SENT            // Budget has been shared with prospect
  VIEWED          // Prospect has viewed the budget
  PENDING_APPROVAL
  APPROVED        // Accepted by prospect/client
  REJECTED
  EXPIRED         // Share link expired
  INVOICED
}

model BudgetItem {
  id            String   @id @default(cuid())
  budget        Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  budgetId      String
  product       Product  @relation(fields: [productId], references: [id])
  productId     String
  quantity      Int
  unitPrice     Decimal  @db.Decimal(20, 6)
  proratedCosts Decimal  @db.Decimal(20, 6) @default(0)
  duties        Decimal  @db.Decimal(20, 6) @default(0)
  freight       Decimal  @db.Decimal(20, 6) @default(0)
  insurance     Decimal  @db.Decimal(20, 6) @default(0)
  totalLine     Decimal  @db.Decimal(20, 6)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ============================================
// PRICING CONFIGURATION
// ============================================

model PricingConfiguration {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id])
  adjustForVAT   Boolean      @default(false)
  vatRate        Decimal?     @db.Decimal(8, 4)
  baseCurrency   String       @default("USD")
  roundingMode   RoundingMode @default(HALF_UP)
  precision      Int          @default(2)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

enum RoundingMode {
  HALF_UP
  DOWN
  UP
}

// ============================================
// INVOICES & PACKING LISTS
// ============================================

model Invoice {
  id            String   @id @default(cuid())
  invoiceNumber String   @unique
  budget        Budget   @relation(fields: [budgetId], references: [id])
  budgetId      String
  pdfUrl        String?
  totalAmount   Decimal  @db.Decimal(20, 6)
  issueDate     DateTime @default(now())
  dueDate       DateTime?
  organization  Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model PackingList {
  id        String   @id @default(cuid())
  budget    Budget   @relation(fields: [budgetId], references: [id])
  budgetId  String
  details   Json
  pdfUrl    String?
  organization  Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id        String   @id @default(cuid())
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  action    String
  resource  String?
  before    Json?
  after     Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
}